# Документация по Документам (Documents)

Этот документ предоставляет исчерпывающее руководство по созданию, настройке и использованию **Документов** в системе UnityBook.

## 1. Введение в Документы

**Документы** — это центральные, транзакционные объекты системы. Их основная задача — регистрировать хозяйственные операции и события, происходящие в определенный момент времени.

В отличие от [Справочников](./CATALOG.md), которые хранят условно-статичную информацию (списки клиентов, товаров), документы фиксируют факты деятельности компании: продажу, закупку, перемещение, платеж.

**Ключевые атрибуты и роль документов:**
-   **Хронология:** Каждый документ имеет **Номер** и **Дату**, которые однозначно определяют его положение на временной оси и порядок в системе.
-   **Движение данных:** Ключевая особенность документов — их способность делать записи (движения) в [Регистрах накопления](./REGISTER.md) при **проведении**. Именно эти движения формируют все учетные данные в системе (остатки, долги, доходы и расходы).
-   **Основа для бизнес-процессов:** Документы являются основой для построения бизнес-процессов, например, через механизм "Ввод на основании".

**Примеры использования:**
-   `Заказ клиента`: Фиксирует намерение клиента купить товар.
-   `Расходная накладная`: Фиксирует факт отгрузки товаров клиенту и изменяет остатки на складе.
-   `Платежное поручение`: Отражает факт оплаты поставщику и изменяет остаток денег на счете.

---

## 2. Структура Метаданных Документа

Документ определяется объектом в массиве `documents` в главном файле конфигурации.

```json
{
  "id": "doc_sales_invoice",
  "name": "Расходная накладная",
  "abbreviation": "РН",
  "fields": [ ... ],
  "tabularSections": [ ... ],
  "postingRules": [ ... ],
  "createsBasedOn": [ ... ],
  "layout": [ ... ],
  "module": "...",
  "printForms": [ ... ],
  "numberSettings": { ... }
}
```

### 2.1. Основные свойства

Многие свойства документа аналогичны свойствам справочника.

| Свойство | Тип | Описание |
| :--- | :--- | :--- |
| `id` | `string` | **(Обязательно)** Уникальный ID. **Рекомендация:** префикс `doc_`. |
| `name` | `string` | **(Обязательно)** Полное наименование, отображаемое в UI. |
| `abbreviation` | `string`| Краткое наименование. |
| `fields` | `array` | **(Обязательно)** Реквизиты шапки документа. Структура полностью идентична реквизитам справочников. Подробности в [CATALOG.md](./CATALOG.md). |
| `tabularSections`| `array` | Табличные части документа. Структура идентична табличным частям справочников. Подробности в [CATALOG.md](./CATALOG.md). |
| `layout` | `array` | Структура визуального расположения элементов на форме. |
| `module` | `string` | Клиентский JavaScript-модуль для кастомной логики. См. [MODULE.md](./MODULE.md). |
| `printForms` | `array` | Набор печатных форм для документа. См. [PRINT.md](./PRINT.md). |

### 2.2. Специфичные свойства Документа

| Свойство | Тип | Описание |
| :--- | :--- | :--- |
| `postingRules` | `array`| **(Ключевое свойство)** Массив правил, описывающих, как документ влияет на регистры. См. раздел "Проведение Документов". |
| `createsBasedOn` | `array`| Массив правил для настройки механизма "Ввод на основании". См. соответствующий раздел ниже. |
| `numberSettings`| `object`| Настройки для автонумерации документов. |

#### Настройки нумерации (`numberSettings`)
Этот объект позволяет гибко управлять генерацией номеров документов.

- `prefix: string` — Префикс, добавляемый к номеру (например, `"РН-"`).
- `periodicity: string` — Периодичность сброса нумерации. Возможные значения:
    - `"year"`: нумерация сбрасывается каждый год (например, РН-2024-001).
    - `"month"`: сбрасывается каждый месяц.
    - `"day"`: сбрасывается каждый день.
    - `"none"`: сквозная нумерация.
- `readOnly: boolean` — Если `true` (по умолчанию), пользователь не может редактировать номер вручную.

---

## 3. Проведение Документов (`postingRules`)

**Проведение** — это основной процесс, который "активирует" документ, записывая его данные в учетные регистры. Документ может быть "проведен" или "не проведен". Отмена проведения (`распроведение`) удаляет все движения, созданные этим документом.

Правила проведения — это сердце документа. Они задаются в массиве `postingRules`. Каждое правило — это объект, описывающий движение по **одному** регистру.

### 3.1. Структура правила проведения

| Свойство | Тип | Обязательность | Описание |
| :--- | :--- | :--- | :--- |
| `registerId` | `string` | **Да** | `id` регистра накопления, в котором нужно сделать запись. |
| `type` | `string` | **Да** | Тип движения: `'income'` (приход, увеличивает ресурс) или `'expense'` (расход, уменьшает ресурс). |
| `mappings` | `object` | **Да** | Объект, описывающий соответствие полей регистра и данных документа. |
| `condition` | `string` | Нет | JavaScript-выражение, которое определяет, будет ли выполняться правило. Если оно вернет `false`, движение не создается. Удобно для правил, которые должны работать только для определенных строк таблицы. |

### 3.2. Настройка соответствия полей (`mappings`)

Объект `mappings` определяет, откуда брать данные для полей регистра.

-   **Ключ**: Имя поля (измерения или ресурса) в **регистре**.
-   **Значение**: Путь к данным в **документе** или формула.

#### Примеры путей к данным:
1.  **Реквизит шапки:**
    `"Контрагент": "Контрагент.id"`
    *(Берется `id` из поля `Контрагент` в шапке документа.)*

2.  **Реквизит табличной части:**
    `"Номенклатура": "Товары.Номенклатура.id"`
    *(Для **каждой** строки табличной части "Товары" берется `id` из колонки "Номенклатура".)*

3.  **Формула:**
    `"СуммаСебестоимости": "[Товары.Количество] * [Товары.Себестоимость]"`
    *(Для каждой строки ТЧ "Товары" система перемножит значения из колонок "Количество" и "Себестоимость".)*

### 3.3. Пример сложного правила

Документ `РасходнаяНакладная` продает товары и услуги. Нужно списать со склада только товары.

```json
"postingRules": [
  {
    "registerId": "reg_stock_balance",
    "type": "expense",
    "condition": "[Товары.Номенклатура.Тип] === 'Товар'", // Правило сработает только для строк, где номенклатура имеет тип "Товар"
    "mappings": {
      "Склад": "Склад.id", // Из шапки документа
      "Номенклатура": "Товары.Номенклатура.id", // Из текущей строки ТЧ
      "Количество": "Товары.Количество" // Из текущей строки ТЧ
    }
  }
]
```

---

## 4. Ввод на основании (`createsBasedOn`)

Этот механизм позволяет быстро создавать один документ на основе другого, автоматически перенося данные. Например, создать `Расходную накладную` из `Заказа клиента`.

Настройка задается в массиве `createsBasedOn` в **исходном** документе. Каждый объект в массиве — правило для создания одного целевого документа.

### 4.1. Структура правила `createsBasedOn`

```json
{
  "targetDocumentId": "doc_sales_invoice",
  "label": "Создать реализацию",
  "fieldMappings": [
    { "from": "Контрагент", "to": "f_si_counterparty" },
    { "from": "Склад", "to": "f_si_warehouse" }
  ],
  "tabularSectionMappings": [
    {
      "source": "ts_order_products",
      "target": "ts_sales_invoice_products",
      "fieldMappings": [
        { "from": "Номенклатура", "to": "f_si_ts_product" },
        { "from": "Количество", "to": "f_si_ts_quantity" },
        { "from": "Цена", "to": "f_si_ts_price" }
      ]
    }
  ]
}
```

-   `targetDocumentId`: **(Обязательно)** `id` документа, который будет создан.
-   `label`: Текст для кнопки в интерфейсе (например, "Создать реализацию").
-   `fieldMappings`: Массив правил для переноса полей **шапки**.
    -   `from`: Имя поля в **исходном** документе.
    -   `to`: `id` поля в **целевом** документе.
-   `tabularSectionMappings`: Массив правил для переноса **табличных частей**.
    -   `source`: `id` табличной части в **исходном** документе.
    -   `target`: `id` табличной части в **целевом** документе.
    -   `fieldMappings`: Массив правил для колонок таблицы.

---

## 5. Жизненный цикл и Логика Модуля

С помощью [модуля формы](./MODULE.md) можно встраивать сложную логику на разных этапах жизни документа.

-   `ПриОткрытии(formApi)`: Вызывается при открытии формы. Полезно для установки начальных значений.
-   `async ПередЗаписью(formApi)`: Вызывается перед сохранением документа (но не обязательно проведением). Используется для общих проверок. Возврат `false` отменит запись.
-   `async ПередПроведением(formApi)`: **Самый важный хук документа.** Вызывается перед созданием движений в регистрах. Идеальное место для сложных проверок, например, запроса остатков товаров на складе через `formApi.readList()`. Возврат `false` отменяет проведение.
-   `async ПослеПроведения(formApi)`: Вызывается **после** успешного проведения документа. Можно использовать для запуска последующих действий: отправки email, создания задач и т.д.
-   `async ПриОтменеПроведения(formApi)`: Вызывается перед отменой проведения. Позволяет запретить отмену, если, например, на основе этого документа уже созданы другие. Возврат `false` отменит отмену проведения.
-   `ПередЗакрытием(formApi)`: Вызывается при попытке закрыть форму, позволяет задать пользователю вопрос.

Эти хуки превращают документ из простой структуры данных в мощный инструмент автоматизации бизнес-процессов.

