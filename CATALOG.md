# Документация по Справочникам (Catalogs)

Этот документ предоставляет исчерпывающее руководство по созданию, настройке и использованию **Справочников** в системе UnityBook.

## 1. Введение в Справочники

**Справочники** — это фундаментальные объекты системы, предназначенные для хранения и управления нормативно-справочной информацией (НСИ). Эта информация, как правило, является условно-постоянной и многократно используется в различных бизнес-процессах.

В отличие от [Документов](./DOCUMENT.md), которые фиксируют события во времени (транзакции), справочники хранят списки однородных сущностей.

**Ключевая роль справочников:**
-   **Обеспечение целостности данных:** Вместо ручного ввода повторяющейся информации (например, названия клиента), пользователи выбирают значения из справочника, что исключает ошибки и опечатки.
-   **Централизация управления данными:** Информация о клиенте или товаре хранится в одном месте. При изменении, например, адреса клиента, он автоматически обновится во всех связанных документах.
-   **Аналитика:** Справочники служат аналитическими "разрезами" для отчетов. Например, отчет по продажам можно сгруппировать по клиентам, товарам или менеджерам, которые являются элементами справочников.

**Примеры использования:**
-   `Номенклатура`: Список товаров и услуг компании.
-   `Контрагенты`: База клиентов, поставщиков, партнеров.
-   `Сотрудники`: Список всех сотрудников компании.
-   `Склады`: Перечень мест хранения товаров.
-   `Статьи затрат`: Классификатор для учета расходов.

---

## 2. Структура Метаданных Справочника

Каждый справочник определяется объектом в массиве `catalogs` в главном файле конфигурации. Ниже приведено подробное описание каждого свойства.

```json
{
  "id": "cat_employees",
  "name": "Сотрудники",
  "abbreviation": "Сотр.",
  "isHierarchical": true,
  "fields": [ ... ],
  "tabularSections": [ ... ],
  "layout": [ ... ],
  "module": "...",
  "printForms": [ ... ]
}
```

| Свойство | Тип | Обязательность | Описание |
| :--- | :--- | :--- | :--- |
| `id` | `string` | **Да** | Уникальный системный идентификатор справочника. Используется для ссылок из других объектов. **Рекомендация:** Используйте префикс `cat_` для ясности (например, `cat_products`). |
| `name` | `string` | **Да** | Полное, человеко-читаемое наименование. Отображается в главном меню, заголовках форм и отчетов. |
| `abbreviation` | `string` | Нет | Краткое наименование. Используется для компактного отображения, например, в заголовках вкладок или узких колонках. |
| `isHierarchical`| `boolean` | Нет | Указывает, является ли справочник иерархическим (поддерживает папки). По умолчанию `false`. См. раздел "Иерархия". |
| `fields` | `array` | **Да** | Массив объектов, описывающих реквизиты (поля) справочника. Это основа структуры данных. См. раздел "Реквизиты". |
| `tabularSections`| `array` | Нет | Массив объектов, описывающих табличные части справочника. См. раздел "Табличные части". |
| `layout` | `array` | Нет | Структура, описывающая визуальное расположение полей, групп и табличных частей на форме элемента. |
| `module` | `string` | Нет | Строка с кодом JavaScript для реализации кастомной бизнес-логики формы. Подробности в [MODULE.md](./MODULE.md). |
| `printForms` | `array` | Нет | Массив объектов, определяющих печатные формы для элементов справочника (например, карточка товара). Подробности в [PRINT.md](./PRINT.md). |

---

## 3. Реквизиты (Поля)

Реквизиты определяют, какая информация будет храниться в каждом элементе справочника. Они задаются как массив объектов в свойстве `fields`.

### 3.1. Общие свойства реквизита

Каждый реквизит, независимо от его типа, может иметь следующий набор свойств.

| Свойство | Тип | Описание и примеры |
| :--- | :--- | :--- |
| `id` | `string` | **(Обязательно)** Уникальный ID поля в рамках объекта. **Рекомендация:** `f_` префикс. Пример: `"f_emp_fullname"`. |
| `name` | `string` | **(Обязательно)** Лейбл поля, который видит пользователь. Пример: `"Полное имя"`. |
| `type` | `string` | **(Обязательно)** Тип данных поля. Определяет его поведение и внешний вид. См. подробное описание типов ниже. |
| `required` | `boolean`| Если `true`, поле становится обязательным для заполнения. В интерфейсе помечается звездочкой (*). |
| `readOnly` | `boolean`| Если `true`, поле недоступно для редактирования. Используется для полей, вычисляемых автоматически. |
| `hidden` | `boolean`| Если `true`, поле не отображается на форме. При этом оно существует в данных и доступно через `formApi` в модуле формы. |
| `showInJournal`| `boolean`| Если `false`, колонка не будет отображаться в форме списка справочника. По умолчанию `true`. |
| `defaultValue` | `any` | Значение по умолчанию для поля при создании *нового* элемента. Для поля-ссылки значением должен быть объект: `{"id": "...", "Наименование": "..."}`. |
| `expression` | `string` | Формула для автоматического расчета значения. Использует синтаксис `[Имя поля]`. Пример: `"[Фамилия] + ' ' + [Имя]"`. |
| `autofillFrom` | `object` | Правило для автозаполнения из другого поля-ссылки. Пример: `{ "referenceFieldId": "f_employee", "sourceFieldName": "Email" }` заполнит текущее поле значением `Email` из выбранного сотрудника. |
| `tooltip` | `string` | Текст подсказки, который появляется при наведении на иконку вопроса (?) рядом с полем. |
| `placeholder`| `string` | Текст-заполнитель, отображаемый в пустом поле ввода. |

### 3.2. Типы данных реквизитов (`type`)

#### `string`
Самый распространенный тип для текстовой информации.

-   **Дополнительные свойства:**
    -   `length: number` — Максимальная длина строки. Включает валидацию.
    -   `multiline: boolean` — Если `true`, поле будет отображаться как многострочный `textarea`.
    -   `isFile: boolean` — Если `true`, поле превращается в контрол для загрузки файла. В базе хранится путь к файлу.
    -   `isHtml: boolean` — Если `true`, поле будет отображаться как WYSIWYG-редактор для форматирования текста.

#### `number`
Для хранения числовых значений.

-   **Дополнительные свойства:**
    -   `precision: number` — Количество знаков после запятой.
    -   `minValue: number` — Минимально допустимое значение (включая валидацию).
    -   `maxValue: number` — Максимально допустимое значение (включая валидацию).

#### `boolean`
Хранит `true` или `false`. Отображается как чек-бокс.

#### `date`
Для хранения даты и/или времени.

-   **Дополнительные свойства:**
    -   `dateVariant: string` — Уточняет формат ввода: `"date"` (только дата) или `"datetime-local"` (дата и время).

#### `enum` (Перечисление)
Для полей, значение которых должно выбираться из предопределенного списка. Отображается как выпадающий список.

-   **Дополнительные свойства:**
    -   `values: string[]` — Массив строк, которые будут и значениями, и метками в списке.
        -   Пример: `"values": ["Активен", "В отпуске", "Уволен"]`

#### `reference` (Ссылка)
Один из самых важных типов. Создает связь с элементом другого справочника или документа.

-   **Дополнительные свойства:**
    -   `referenceTo: string` — **(Обязательно)** `id` справочника или документа, на который указывает ссылка. Пример: `"referenceTo": "cat_departments"`.
    -   `filter: object` — (Продвинутая функция) Позволяет динамически фильтровать записи в форме выбора. Ключи объекта — имена полей **целевого справочника**, значения — значения для фильтрации.
        -   **Пример:** В документе есть поле `Страна`. При выборе города в поле `Город`, мы хотим показывать только города из выбранной страны. Фильтр для поля `Город` будет выглядеть так: `"filter": { "Страна.id": formValue.country.id }`.

---

## 4. Иерархия и Группы

Свойство `"isHierarchical": true` в метаданных справочника включает иерархический режим. Это позволяет пользователям создавать папки (группы) для организации элементов, превращая плоский список в древовидную структуру.

-   **Как это работает:** Система автоматически добавляет в данные элемента невидимое поле `parent`, которое хранит `id` родительской папки. Элементы, являющиеся папками, имеют внутреннее свойство `_isFolder: true`.
-   **Пользовательский интерфейс:**
    -   В форме списка появляется древовидная навигация.
    -   Кнопка "Создать группу" позволяет добавить новую папку.
    -   В форме элемента появляется системное поле "Родитель" или "Группа", позволяющее перемещать элемент между папками.

---

## 5. Табличные части

Табличные части (`tabularSections`) позволяют хранить списки связанных данных внутри одного элемента справочника. Например, список контактных лиц у контрагента или состав комплекта у товара.

Структура `tabularSections` — это массив объектов, где каждый объект описывает одну таблицу.

```json
"tabularSections": [
  {
    "id": "ts_contacts",
    "name": "Контактные лица",
    "fields": [
      { "id": "tsf_con_name", "name": "Имя", "type": "string", "required": true },
      { "id": "tsf_con_position", "name": "Должность", "type": "string" },
      { "id": "tsf_con_email", "name": "Email", "type": "string" }
    ]
  }
]
```
- `id`: Уникальный ID таблицы. **Рекомендация:** префикс `ts_`.
- `name`: Заголовок таблицы на форме.
- `fields`: Массив реквизитов таблицы. **Структура этих реквизитов полностью идентична обычным реквизитам справочника**, включая все свойства и типы. **Рекомендация:** для ID полей таблицы используйте префикс `tsf_` (Tabular Section Field).

---

## 6. Формы и Представление

### Форма Элемента
Внешний вид формы редактирования элемента настраивается с помощью свойства `layout`. Оно позволяет гибко располагать поля и табличные части, объединять их в группы и вкладки для создания удобного и логичного интерфейса.

### Форма Списка
Форма списка (журнал) — основной инструмент для просмотра и навигации по элементам справочника.

-   **Колонки:** Состав колонок определяется реквизитами справочника, у которых свойство `showInJournal` установлено в `true`.
-   **Сортировка:** По умолчанию сортировка происходит по стандартным полям "Наименование" или "Код". Можно задать сортировку по умолчанию через свойства в метаданных справочника:
    -   `defaultSortField: string` — `id` поля для начальной сортировки.
    -   `defaultSortDirection: 'asc' | 'desc'` — Направление сортировки.
-   **Поиск и Фильтр:** В верхней части формы списка есть строка поиска, которая ищет совпадения по всем видимым текстовым колонкам.

---

## 7. Продвинутые возможности

Справочники поддерживают те же мощные механизмы кастомизации, что и документы:
-   **Модуль (`module`)**: Позволяет встраивать сложную бизнес-логику. Например, при записи нового контрагента можно использовать `formApi.readList` для проверки уникальности его ИНН по всей базе данных и отменить сохранение, если дубликат найден. Подробности см. в [MODULE.md](./MODULE.md).
-   **Печатные формы (`printForms`)**: Позволяет создавать шаблоны для печати (например, "Карточка контрагента" или "Прайс-лист" на основе справочника номенклатуры). Подробности см. в [PRINT.md](./PRINT.md).

