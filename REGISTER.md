# Документация по Регистрам (Registers)

Этот документ предоставляет исчерпывающее руководство по **Регистрам** — специализированным структурам данных, которые являются ядром всей учетной системы UnityBook.

## 1. Концепция Регистров

**Регистры** — это не просто таблицы для хранения данных. Это высокооптимизированные структуры, предназначенные для накопления и быстрого получения агрегированной информации (итогов). Они служат "учетной книгой" или "гроссбухом" системы.

**Ключевые принципы:**

1.  **Пассивность:** Регистры никогда не изменяются напрямую пользователем. Записи в них (называемые **движениями**) создаются и удаляются исключительно автоматически при **проведении** и **отмене проведения** [Документов](./DOCUMENT.md). Документ, который делает движения, называется *регистратором*.
2.  **Структура по ролям:** В отличие от справочников и документов, поля регистра имеют не просто тип данных, а специальную **роль**, которая определяет их поведение в учетной системе: **Измерение, Ресурс** или **Реквизит**.
3.  **Агрегация:** Главная цель регистров — давать быстрые ответы на вопросы об итогах, такие как "Сколько товара осталось на складе?" (остатки) или "На какую сумму было продано за месяц?" (обороты).

---

## 2. Структура Метаданных Регистра

Регистр определяется объектом в массиве `registers` в файле конфигурации.

| Свойство | Тип | Обязательность | Описание |
| :--- | :--- | :--- | :--- |
| `id` | `string` | **Да** | Уникальный ID. **Рекомендация:** префикс `reg_`. |
| `name` | `string` | **Да** | Пользовательское наименование, используемое в отчетах и интерфейсе. |
| `type` | `string` | **Да** | Тип регистра. Определяет его фундаментальное поведение. См. раздел "Типы Регистров". |
| `fields` | `array` | **Да** | Массив объектов, описывающих поля регистра и их роли. |

---

## 3. Поля Регистра и их Роли

Это самая важная концепция регистров. Каждое поле в регистре должно иметь одну из трех ролей, которая задается специальным булевым флагом.

### 3.1. Измерения (`isDimension: true`) — Контекст "ЧТО?"

**Измерения** — это аналитические "срезы" или контекст, в рамках которого ведется учет. Уникальная комбинация значений всех измерений образует ключ записи, для которого будут накапливаться ресурсы.

-   **Аналогия:** Оси на графике. Если вы хотите увидеть график продаж, осями будут, например, "Товар" и "Месяц".
-   **Пример 1 (Остатки товаров):** Чтобы знать остаток каждого товара на каждом складе, измерениями должны быть `Товар` и `Склад`.
-   **Пример 2 (Долги клиентов):** Чтобы знать долг каждого клиента, измерением будет `Контрагент`.
-   **Типы данных:** Обычно это ссылки (`reference`), строки (`string`), числа или даты.

```json
// Измерение "Склад" в регистре остатков
{ 
  "id": "f_stock_warehouse", 
  "name": "Склад", 
  "type": "reference", 
  "referenceTo": "cat_warehouses", 
  "isDimension": true 
}
```

### 3.2. Ресурсы (`isResource: true`) — Значение "СКОЛЬКО?"

**Ресурсы** — это числовые значения, которые система накапливает. Это и есть те показатели, итоги по которым мы хотим получать.

-   **Аналогия:** Значение точки на графике.
-   **Пример:** `Количество`, `Сумма`, `Вес`, `Объем`.
-   **Поведение:** Значение ресурса увеличивается при движении типа `income` (приход) и уменьшается при движении `expense` (расход).
-   **Типы данных:** Обязательно `number`.

```json
// Ресурс "Количество" в регистре остатков
{ 
  "id": "f_stock_qty", 
  "name": "Количество", 
  "type": "number",
  "precision": 3,
  "isResource": true 
}
```

### 3.3. Реквизиты (`isAttribute: true`) — "Дополнительная информация"

**Реквизиты** — это дополнительная информация, которая привязывается к каждому движению, но **не участвует в агрегации итогов**. Они служат для описательных целей и полезны при анализе отдельных движений.

-   **Аналогия:** Комментарий к банковской транзакции. Он виден в выписке, но не влияет на итоговый баланс.
-   **Пример:** `Комментарий`, `ОтветственныйМенеджер`, `НомерПартии`.
-   **Использование:** Реквизиты незаменимы в отчетах, где требуется детализация "до документа". Например, в отчете по продажам можно вывести реквизит "Менеджер", чтобы видеть, кто именно совершил продажу.

```json
// Реквизит "Менеджер" в регистре продаж
{ 
  "id": "f_sales_manager", 
  "name": "Менеджер", 
  "type": "reference",
  "referenceTo": "cat_employees",
  "isAttribute": true 
}
```

---

## 4. Типы Регистров

Свойство `type` определяет фундаментальную логику работы регистра.

### 4.1. Тип `accumulation` (Регистр накопления)

Основной тип регистра, предназначенный для расчета **остатков** и **оборотов**.

-   **Остатки:** Это итоговое значение ресурсов на определенный момент времени в разрезе измерений. Рассчитывается как `(сумма всех приходов) - (сумма всех расходов)`.
-   **Обороты:** Это сумма всех приходных или расходных движений за выбранный период.

**Примеры:** `ОстаткиТоваров`, `ВзаиморасчетыСКлиентами`, `ДвиженияДенежныхСредств`.

### 4.2. Тип `information` (Регистр сведений)

Этот тип регистра не накапливает данные, а хранит информацию, актуальную на определенную дату (или просто набор записей). У него нет понятий "приход" и "расход".

-   **Назначение:** Идеально подходит для хранения периодически изменяющихся данных.
-   **Примеры:**
    -   **Курсы валют:** Измерения - `Валюта`, `Дата`. Ресурс - `Курс`.
    -   **Цены номенклатуры:** Измерения - `Номенклатура`, `ТипЦены`, `Дата`. Ресурс - `Цена`.
    -   **Контактные данные:** Измерения - `Контрагент`. Реквизиты - `Адрес`, `Телефон`.

---

## 5. Взаимодействие с Документами

Регистры наполняются данными только через `postingRules` в [Документах](./DOCUMENT.md). Один документ может делать движения сразу в нескольких регистрах.

**Пример:** Документ `РасходнаяНакладная` при проведении делает 3 движения:
1.  Списывает товар со склада (расход в регистре `ОстаткиТоваров`).
2.  Увеличивает долг клиента (приход в регистре `ДолгиКлиентов`).
3.  Фиксирует выручку и себестоимость (приход в регистре `Продажи`).

```json
// В метаданных документа "РасходнаяНакладная"
"postingRules": [
  // Правило 1: Списание остатков
  {
    "registerId": "reg_stock_balance",
    "type": "expense", 
    "mappings": {
      "Склад": "Склад.id",
      "Номенклатура": "Товары.Номенклатура.id",
      "Количество": "Товары.Количество"
    }
  },
  // Правило 2: Увеличение долга клиента
  {
    "registerId": "reg_customer_debt",
    "type": "income",
    "mappings": {
      "Контрагент": "Контрагент.id",
      "Сумма": "ИтогПоДокументу"
    }
  },
  // Правило 3: Фиксация данных о продаже
  {
    "registerId": "reg_sales_turnover",
    "type": "income",
    "mappings": {
      "Контрагент": "Контрагент.id",
      "Номенклатура": "Товары.Номенклатура.id",
      "СуммаПродажи": "Товары.Сумма",
      "Себестоимость": "[Товары.Количество] * [Товары.Себестоимость]" // Пример с формулой
    }
  }
]
```

---

## 6. Получение Данных и Отчетность

-   **Просмотр движений:** Форма списка регистра позволяет увидеть "сырые" данные — все отдельные записи с указанием документа-регистратора. Это используется для отладки и детального анализа.
-   **Построение отчетов:** Истинная мощь регистров раскрывается в отчетах. Специальные инструменты (например, "Универсальный отчет") позволяют строить отчеты, выполняя запросы к агрегированным данным без необходимости писать код.

**Примеры запросов к отчетам на естественном языке:**
-   **Отчет "Остатки товаров":** "Покажи итоговую сумму ресурса `Количество` в регистре `ОстаткиТоваров` на *конец дня* в разрезе измерений `Склад` и `Номенклатура`".
-   **Отчет "Продажи за период":** "Покажи сумму оборотов по ресурсам `СуммаПродажи` и `Себестоимость` в регистре `Продажи` за *выбранный период* в разрезе измерения `Контрагент`".

