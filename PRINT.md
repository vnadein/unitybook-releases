# Документация по Системе Печатных Форм

Этот документ — исчерпывающее руководство по созданию, настройке и использованию **Печатных Форм** в системе UnityBook.

## 1. Концепция Системы Печатных Форм

Система печатных форм предназначена для генерации "pixel-perfect" HTML-документов на основе данных объектов системы (справочников или документов). Она позволяет создавать счета, накладные, акты, этикетки, отчеты и любые другие печатные представления.

**Основные компоненты:**
1.  **Метаданные:** Объект в конфигурации, описывающий свойства формы.
2.  **HTML-шаблон:** Разметка с плейсхолдерами для вставки данных.
3.  **CSS-стили:** Стили для оформления внешнего вида.
4.  **Data Selector:** Опциональный JavaScript-обработчик для сложной подготовки данных.

## 2. Структура Метаданных Печатной Формы

Каждая печатная форма определяется объектом в массиве `printForms` в метаданных справочника или документа.

| Свойство | Тип | Обязательность | Описание |
| :--- | :--- | :--- | :--- |
| `id` | `string` | **Да** | Уникальный идентификатор печатной формы. |
| `name` | `string` | **Да** | Наименование, которое отображается в меню "Печать". |
| `description` | `string` | Нет | Краткое описание, видимое пользователю при наведении. |
| `template` | `string` | **Да** | Строка, содержащая HTML-шаблон. Рекомендуется использовать шаблонные строки (\` \`) для удобства. |
| `styles` | `string` | Нет | Строка, содержащая CSS-стили, которые будут встроены в `<head>` HTML-документа. |
| `templateType`| `string` | Нет | Тип шаблона. По умолчанию `"html"`. |
| `dataSelector`| `string` | Нет | Строка с кодом JavaScript для продвинутой подготовки данных. См. раздел 4. |
| `defaultSettings`| `object`| Нет | Объект с настройками печати по умолчанию. |
| `autoPrint` | `boolean`| Нет | Если `true`, диалог печати браузера откроется автоматически после рендеринга формы. |

#### Настройки по умолчанию (`defaultSettings`)
| Свойство | Тип | Описание |
| :--- | :--- | :--- |
| `paperSize` | `string` | Размер бумаги: `"A4"`, `"A5"`, `"Letter"`. |
| `orientation`| `string` | Ориентация: `"portrait"` (книжная) или `"landscape"` (альбомная). |
| `margins` | `object` | Отступы страницы. Пример: `{ "top": "10mm", "bottom": "10mm", "left": "15mm", "right": "10mm" }`. |

---

## 3. Синтаксис Шаблонов

Шаблонизатор позволяет гибко вставлять данные в HTML, использовать условные блоки, циклы и функции-хелперы.

### 3.1. Вывод данных и Хелперы

Для вставки данных используется синтаксис `${...}`. Кроме простых полей, можно использовать встроенные хелперы.

| Синтаксис | Описание |
| :--- | :--- |
| `${Номер}` | Вставка значения поля `Номер`. |
| `${Контрагент.Наименование}` | Доступ к реквизитам связанных объектов. |
| `formatDate(${Дата}, 'dd.MM.yyyy')` | Форматирование даты. |
| `formatNumber(${Сумма}, 2, ',', ' ')` | Форматирование числа (2 знака после запятой, зпт - разделитель, пробел - разделитель тысяч). |
| `numberToWords(${Итого})` | **Сумма прописью.** Преобразует число в текстовое представление. |
| `qrCode('https://example.com/pay/' + ${id})` | Генерирует тег `<img>` с QR-кодом из переданной строки. |
| `barcode(${Артикул}, 'CODE128')`| Генерирует тег `<img>` с штрих-кодом. Поддерживаемые форматы: `CODE128`, `EAN13` и др. |

### 3.2. Условные блоки (`data-if`)

Атрибут `data-if` на теге `<template>` позволяет отображать блок HTML только при выполнении условия.

-   **Проверка на наличие:** `data-if="Комментарий"` (блок отобразится, если "Комментарий" не пустой).
-   **Проверка с отрицанием:** `data-if="!Комментарий"`
-   **Сложные условия:** `data-if="Статус === 'Оплачен' && Сумма > 1000"`

```html
<template data-if="Контрагент.Тип === 'Юр. лицо'">
  <p>ИНН: ${Контрагент.ИНН}, КПП: ${Контрагент.КПП}</p>
</template>
```

### 3.3. Циклы по Табличным Частям (`data-forEach`)

Для вывода строк из табличной части используется атрибут `data-forEach="ИмяТабличнойЧасти"` на теге `<template>`, который оборачивает собой тег `<tr>` (или любой другой повторяемый блок).

#### Контекст внутри цикла
Внутри цикла `data-forEach` доступны специальные переменные:

| Переменная | Описание |
| :--- | :--- |
| `${Таблица._index}` | Индекс текущей строки (начиная с 0). |
| `${Таблица._number}`| Порядковый номер строки (начиная с 1). |
| `${Таблица._isFirst}`| `true` для первой строки цикла. |
| `${Таблица._isLast}` | `true` для последней строки цикла. |
| `${Таблица._parent}`| Доступ к данным "родительского" объекта (шапки документа). |

**Пример вывода таблицы:**
```html
<tbody>
  <template data-forEach="Товары">
    <tr>
      <td>${Товары._number}</td>
      <td>${Товары.Номенклатура.Наименование}</td>
      <td>${Товары.Количество}</td>
      <td>${formatNumber(Товары.Цена, 2, '.', ' ')}</td>
      <td>${formatNumber(Товары.Сумма, 2, '.', ' ')}</td>
    </tr>
  </template>
</tbody>
```

---

## 4. Продвинутая Подготовка Данных (`dataSelector`)

Для сложных сценариев, когда данных текущего объекта недостаточно, используется `dataSelector`. Это асинхронная JavaScript-функция, которая выполняется на сервере **перед** передачей данных в шаблонизатор.

-   **Сигнатура:** `async function(objectData, systemApi)`
    -   `objectData`: Данные текущего объекта, который печатается.
    -   `systemApi`: API для доступа к базе данных. Имеет два метода: `read(type, name, id)` и `readList(type, name, filter)`.
-   **Задача:** Функция должна вернуть `Promise`, который разрешается в **новый, модифицированный объект с данными**, который и будет использоваться для печати.

**Пример: Добавление итогов и данных о директоре в счет**
```javascript
// Код в свойстве dataSelector
async function(objectData, systemApi) {
  // 1. Считаем итоги по табличной части
  let total = 0;
  if (objectData.Товары) {
    for (const item of objectData.Товары) {
      total += item.Сумма || 0;
    }
  }
  
  // 2. Добавляем новые поля в объект данных
  objectData.ИтоговаяСумма = total;
  objectData.ИтогоСуммаПрописью = systemApi.numberToWords(total); // В systemApi тоже есть хелперы

  // 3. Получаем дополнительные данные из другого справочника
  try {
    const settings = await systemApi.readList('Справочник', 'НастройкиОрганизации');
    if (settings && settings.length > 0) {
      objectData.Директор = settings[0].Директор?.Наименование;
      objectData.ГлавныйБухгалтер = settings[0].ГлавныйБухгалтер?.Наименование;
    }
  } catch (e) {
    // Обработка ошибки, если справочник не найден
    objectData.Директор = '________________';
    objectData.ГлавныйБухгалтер = '________________';
  }

  // 4. Обязательно возвращаем измененный объект
  return objectData;
}
```
Теперь в шаблоне можно использовать плейсхолдеры `${ИтоговаяСумма}`, `${ИтогоСуммаПрописью}` и `${Директор}`.

---

## 5. Стилизация и CSS

CSS-стили, определенные в свойстве `styles`, вставляются напрямую в `<head>` генерируемого HTML. Это обеспечивает инкапсуляцию стилей для каждой печатной формы.

**Рекомендации для печати:**
-   **Единицы измерения:** Используйте абсолютные единицы (`mm`, `cm`, `pt`), а не `px`, для точного позиционирования на листе.
-   **Разрывы страниц:** Управляйте разрывами страниц, чтобы таблицы не "рвались" в неподходящих местах.
    -   `page-break-before: always;` — для начала нового элемента с новой страницы.
    -   `page-break-inside: avoid;` — для `<tr>` или блоков, которые не должны разрываться.
-   **Скрытие ненужного:** Используйте `@media print`, чтобы скрыть элементы, ненужные при печати.
    ```css
    @media print {
      .no-print {
        display: none;
      }
    }
    ```
-   **Шрифты:** Задавайте конкретные семейства шрифтов, чтобы печатная форма выглядела одинаково на разных компьютерах.
