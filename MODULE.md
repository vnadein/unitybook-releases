# Документация по Модулю Формы Объекта

Этот документ — исчерпывающее руководство по **Модулю Формы**, самому мощному инструменту для программной настройки и автоматизации в системе UnityBook.

## 1. Концепция Модуля Формы

Если декларативных настроек (таких как `expression` или `autofillFrom`) недостаточно, вы можете подключить к любому справочнику или документу **Модуль Формы**.

**Модуль** — это свойство в метаданных объекта (`catalogs` или `documents`), содержащее строку с кодом JavaScript. Этот код выполняется на стороне клиента (в браузере) и открывает практически безграничные возможности для кастомизации:
-   Сложная, многоступенчатая валидация данных.
-   Динамическое изменение интерфейса формы (скрытие/показ, блокировка полей).
-   Выполнение запросов к базе данных для получения дополнительной информации.
-   Интеграция со сторонними сервисами через `fetch`.
-   Создание собственных кнопок и команд.

Основной точкой входа и вашим главным инструментом в модуле является глобально доступный объект `formApi`.

## 2. Интерфейс `formApi`

`formApi` — это мост между вашим кодом и системой. Он предоставляет набор простых и мощных методов для управления формой и данными.

### 2.1. Взаимодействие с Формой

Эти методы позволяют управлять состоянием текущей, открытой у пользователя формы.

| Метод | Описание |
| :--- | :--- |
| `getValue(fieldName)` | Возвращает *текущее, еще не сохраненное* значение поля. Для табличных частей вернет массив объектов. |
| `setValue(fieldName, value, opts)` | Устанавливает значение для поля. `opts` - опциональный объект: `{ triggerAutomation: boolean }`. Если `triggerAutomation: false`, `expression` и `autofillFrom` для этого поля не сработают. |
| `setFieldState(fieldName, state)` | **(Очень важно!)** Динамически изменяет состояние поля. `state` - объект вида `{ readOnly?: boolean, hidden?: boolean, required?: boolean }`. |
| `showAlert(message, opts)` | Показывает модальное окно с сообщением. `opts`: `{ title?: string, variant?: 'info' | 'success' | 'warning' | 'error' }`. |
| `showConfirm(message, opts)` | Показывает диалог подтверждения (Да/Нет). Возвращает `Promise<boolean>`. `opts`: `{ title?: string }`. |
| `getContext()` | Возвращает объект с контекстом: `{ currentUser: object, objectMeta: object }`. Дает доступ к данным текущего пользователя и метаданным объекта. `currentUser` содержит поля `id`, `name`, `groups`. |

**Пример динамического UI:**
```javascript
// Сделать поле "ПричинаБлокировки" обязательным, если установлен флаг "Заблокирован"
function ПриИзменении_Заблокирован(newValue, formApi) {
  if (newValue === true) {
    formApi.setFieldState('ПричинаБлокировки', { required: true, hidden: false });
  } else {
    formApi.setFieldState('ПричинаБлокировки', { required: false, hidden: true });
    formApi.setValue('ПричинаБлокировки', '');
  }
}
```

### 2.2. Работа с Табличными Частями

| Метод | Описание |
| :--- | :--- |
| `getTabularSection(sectionName)` | Возвращает все строки табличной части в виде массива объектов. |
| `addTabularSectionRow(sectionName, rowData)`| Добавляет новую строку в конец таблицы. `rowData` - объект с данными для новой строки. |
| `updateTabularSectionRow(sectionName, rowIndex, newRowData)` | Обновляет строку по ее индексу (`rowIndex`, начинается с 0). `newRowData` - объект с новыми данными. |
| `deleteTabularSectionRow(sectionName, rowIndex)` | Удаляет строку по ее индексу. |

### 2.3. Доступ к Данным Системы (CRUD API)

Все эти методы **асинхронные** и должны вызываться с `await`. Они позволяют вашему коду взаимодействовать с **любыми** данными в системе.

| Метод | Описание |
| :--- | :--- |
| `read(type, name, id)` | Читает **один** объект по его ID. `type`: "Справочник" \| "Документ" \| "Регистр". `name`: имя из метаданных. |
| `readList(type, name, filter)`| Читает **массив** объектов. `filter` - объект для фильтрации. `type`: "Справочник" \| "Документ" \| "Регистр". |
| `save(type, name, objectData)`| Создает или обновляет объект. Если в `objectData` есть `id`, это обновление, иначе — создание. `type`: "Справочник" \| "Документ" \| "Регистр". |
| `delete(type, name, id)` | Безвозвратно удаляет объект из базы данных. `type`: "Справочник" \| "Документ" \| "Регистр". |

#### Продвинутая фильтрация в `readList`
Объект `filter` может содержать операторы для более сложных запросов.
```javascript
// Найти все товары дороже 100 USD
const expensiveProducts = await formApi.readList('Справочник', 'Номенклатура', {
  'Цена': { '>': 100 }, // Операторы: '>', '<', '>=', '<=', '!='
  'Валюта.Код': 'USD' // Фильтрация по реквизиту связанного объекта
});
```

---

## 3. События Формы и Жизненный Цикл

Система автоматически вызывает функции из вашего модуля на разных этапах жизни формы. Имена этих функций предопределены. Это основной способ встраивания логики.

### 3.1. Порядок вызова событий

1.  `ПриОткрытии`
2.  `ПриИзменении_{ИмяПоля}` (при любом изменении)
3.  *Пользователь нажимает "Записать" / "Провести"*
4.  `async ПередЗаписью`
5.  *Данные сохраняются в БД*
6.  `ПослеЗаписи`
7.  `async ПередПроведением` (только для документов)
8.  *Создаются движения в регистрах*
9.  `async ПослеПроведения` (только для документов)
10. *Пользователь нажимает "Закрыть"*
11. `ПередЗакрытием`

### 3.2. Описание Хуков

#### Основные хуки
-   `ПриОткрытии(formApi)`: Вызывается один раз при загрузке формы. Идеально для начальной настройки вида формы.
-   `ПриИзменении_{ИмяПоля}(newValue, formApi)`: **(Рекомендуемый способ)** Вызывается сразу после изменения значения конкретного поля. `ИмяПоля` заменяется на `name` поля из метаданных. **Важно:** Если имя поля из метаданных содержит пробелы (например, "Статус заявки"), то в имени функции пробелы должны быть заменены на нижние подчеркивания (например, `ПриИзменении_Статус_заявки`). Пример: `ПриИзменении_Статус(newValue, formApi) { ... }`.
-   `async ПередЗаписью(formApi)`: Вызывается перед сохранением. Возврат `false` отменяет запись. Можно вернуть объект `{ 'Поле': 'Новое значение' }`, который будет объединен с данными формы перед сохранением.
-   `ПослеЗаписи(formApi)`: Вызывается после успешного сохранения данных в БД.
-   `ПередЗакрытием(formApi)`: Вызывается при попытке закрыть форму. Возврат `false` отменяет закрытие.

#### Хуки Документов
-   `async ПередПроведением(formApi)`: **Самый важный хук документа.** Вызывается перед созданием движений. Используется для проверок остатков, лимитов и т.д. Возврат `false` отменяет проведение.
-   `async ПослеПроведения(formApi)`: Вызывается после успешного проведения. Удобно для запуска связанных бизнес-процессов (например, отправки уведомлений).
-   `async ПриОтменеПроведения(formApi)`: Вызывается перед отменой проведения. Возврат `false` отменяет отмену проведения.

---

## 4. Пользовательские Команды

Вы можете добавлять на форму кнопки, которые будут вызывать функции из вашего модуля.

**Шаг 1:** Определите функцию в модуле. Она должна принимать `formApi`.
```javascript
// Код в meta.module
async function ПроверитьОстаткиНаСкладе(formApi) {
  const склад = formApi.getValue('Склад');
  if (!склад) {
    formApi.showAlert('Сначала выберите склад!', { variant: 'warning' });
    return;
  }
  // ... сложная логика запроса остатков через formApi.readList ...
  formApi.showAlert('Все товары в наличии!', { variant: 'success' });
}
```

**Шаг 2:** Добавьте кнопку в `layout` метаданных объекта.
```json
// В meta.layout
{
  "type": "button",
  "label": "Проверить остатки",
  "action": "ПроверитьОстаткиНаСкладе", // Имя функции из модуля
  "variant": "outline" // Стиль кнопки
}
```

---

## 5. Паттерны и Лучшие Практики

### 5.1. Управление доступом на основе роли (группы)

С помощью `formApi.getContext()` можно реализовать сложную логику доступа к полям или действиям в зависимости от того, в какие группы входит текущий пользователь.

```javascript
// В модуле документа "ЗаказКлиента"
function ПриОткрытии(formApi) {
  const { currentUser } = formApi.getContext();

  // Проверяем, входит ли пользователь в группу "Менеджеры по продажам"
  const isSalesManager = currentUser.groups.includes('sales_managers'); // 'sales_managers' - ID группы

  // Если пользователь не менеджер, делаем поле "Скидка" только для чтения
  if (!isSalesManager) {
    formApi.setFieldState('Скидка', { readOnly: true });
    formApi.showAlert(
      'Редактирование скидки доступно только менеджерам по продажам.',
      { title: 'Ограничение доступа', variant: 'info' }
    );
  }
}
```

### 5.2. Проверка остатков перед проведением документа

Это канонический пример использования `ПередПроведением`.

```javascript
// В модуле документа "Расходная накладная"
async function ПередПроведением(formApi) {
  const склад = formApi.getValue('Склад');
  const товары = formApi.getTabularSection('Товары');

  for (const item of товары) {
    const nomenclatureId = item['Номенклатура']?.id;
    if (!nomenclatureId) continue;

    // Запрашиваем остатки по конкретному товару и складу
    // Предполагается, что есть регистр 'ОстаткиТоваров'
    const movements = await formApi.readList('Регистр', 'ОстаткиТоваров', {
      'Номенклатура': nomenclatureId,
      'Склад': склад.id
    });
    
    // Считаем текущий остаток
    const currentStock = movements.reduce((sum, mov) => sum + mov['Количество'], 0);

    if (currentStock < item['Количество']) {
      formApi.showAlert(
        `Недостаточно товара "${item['Номенклатура'].Наименование}". Остаток: ${currentStock}, требуется: ${item['Количество']}.`,
        { title: 'Ошибка проверки остатков', variant: 'error' }
      );
      return false; // Отменяем проведение
    }
  }

  // Если все проверки пройдены
  return true;
}
```