# Документация по Внешнему API v1

Этот документ описывает, как взаимодействовать с системой UnityBook через внешний RESTful API. API предназначен для интеграции со сторонними системами (CRM, веб-сайты, мобильные приложения) и позволяет выполнять полный спектр операций с данными.

## 1. Общие принципы

-   **Базовый URL:** Все эндпоинты API начинаются с `/api/v1/external`.
-   **Формат данных:** Все данные передаются и принимаются в формате `JSON` с кодировкой `UTF-8`.
-   **Аутентификация:** Все запросы, кроме `/login`, должны быть аутентифицированы.

## 2. Аутентификация

API поддерживает два способа аутентификации: JWT-токены (для сессий) и API-ключи (для сервер-серверной интеграции).

### 2.1. Способ 1: JWT-токен

Идеально подходит для сценариев, где пользователь входит в систему через внешний интерфейс.

**Шаг 1: Получение токена**
`POST /api/v1/external/login`

**Тело запроса:**
```json
{
  "username": "your_api_user",
  "password": "your_password"
}
```

**Успешный ответ (200 OK):**
```json
{
  "success": true,
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```
-   `token`: JWT-токен, который необходимо использовать для всех последующих запросов. Срок действия токена — **1 час**.

**Шаг 2: Использование токена**
Передавайте токен в заголовке `Authorization` по схеме `Bearer`.
`Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`

### 2.2. Способ 2: API-ключ

Рекомендуемый способ для сервер-серверных интеграций. Ключ генерируется в профиле пользователя в UnityBook и не имеет срока действия.

**Использование ключа:**
Передавайте ключ в заголовке `Authorization` по схеме `Api-Key`.
`Authorization: Api-Key YOUR_LONG_LIVED_API_KEY`

### 2.3. Требования к пользователю и правам доступа
-   Пользователь, от имени которого идет работа, должен существовать в системе и иметь пароль.
-   Пользователь должен быть включен в группу, которой предоставлены права на доступ к API (например, **"Внешние пользователи"**).
-   Этой группе в конфигураторе должны быть выданы необходимые права на объекты: чтение, запись, удаление и **проведение** для документов.

---

## 3. Работа с объектами (CRUD)

Эндпоинты для работы с объектами имеют предсказуемую структуру:
`/api/v1/external/{ТипОбъекта}/{ИмяОбъекта}`
`/api/v1/external/{ТипОбъекта}/{ИмяОбъекта}/{IDЗаписи}`

-   `{ТипОбъекта}`: `Справочник` или `Документ`.
-   `{ИмяОбъекта}`: Человеко-читаемое имя из метаданных (`Контрагенты`, `РасходнаяНакладная`).
-   `{IDЗаписи}`: Уникальный ID записи в базе данных.

### 3.1. Чтение списка (`GET`)

`GET /api/v1/external/{ТипОбъекта}/{ИмяОбъекта}`

Возвращает массив объектов. Этот эндпоинт поддерживает мощные операторы для управления выборкой.

#### Фильтрация
-   **Точное совпадение:** `?ИНН=1234567890`
-   **Фильтрация по полю связанного объекта:** `?Контрагент.id=...`
-   **Операторы:**
    -   `[gt]`: больше (`?Цена[gt]=100`)
    -   `[gte]`: больше или равно
    -   `[lt]`: меньше
    -   `[lte]`: меньше или равно
    -   `[ne]`: не равно
    -   `[contains]`: содержит подстроку (для текстовых полей)

#### Сортировка
-   `?_sort=Наименование:asc`
-   `?_sort=Дата:desc`

#### Пагинация
-   `?_page=1&_limit=25`
-   В ответе будут заголовки `X-Total-Count`, указывающие общее количество записей.

#### Выбор полей
-   `?_fields=id,Наименование,ИНН` — для уменьшения объема ответа.

**Пример сложного запроса:** Получить 20 контрагентов на второй странице, у которых ИНН не пустой, отсортированных по наименованию.
`GET /api/v1/external/Справочник/Контрагенты?ИНН[ne]=&_sort=Наименование:asc&_page=2&_limit=20`

### 3.2. Чтение одной записи (`GET`)
`GET /api/v1/external/{ТипОбъекта}/{ИмяОбъекта}/{IDЗаписи}`

### 3.3. Создание записи (`POST`)
`POST /api/v1/external/{ТипОбъекта}/{ИмяОбъекта}`

**Тело запроса:** JSON-объект с полями создаваемой записи.
-   **Поля-ссылки** должны передаваться как объект с `id`: `"Контрагент": { "id": "uuid-..." }`.
-   **Табличные части** передаются как массив объектов: `"Товары": [ { ... }, { ... } ]`.

**Пример создания документа с ТЧ:**
```json
{
  "Дата": "2025-12-20T10:00:00Z",
  "Контрагент": { "id": "cat-counterparty-123" },
  "Склад": { "id": "cat-warehouse-abc" },
  "Товары": [
    {
      "Номенклатура": { "id": "cat-product-xyz" },
      "Количество": 10,
      "Цена": 150.00
    }
  ]
}
```

**Успешный ответ (201 Created):**
```json
{
  "message": "Record created successfully.",
  "id": "new-record-uuid"
}
```

### 3.4. Обновление и частичное обновление (`PUT` / `PATCH`)

-   **`PUT /.../{id}`**: **Полное обновление.** Заменяет весь объект. Все поля должны быть переданы в запросе.
-   **`PATCH /.../{id}`**: **Частичное обновление.** Обновляет только те поля, которые переданы в запросе. **(Рекомендуется)**

### 3.5. Удаление записи (`DELETE`)
`DELETE /api/v1/external/{ТипОбъекта}/{ИмяОбъекта}/{IDЗаписи}`
**Ответ:** `204 No Content` в случае успеха.

---

## 4. Специализированные действия

### 4.1. Проведение документа
`POST /api/v1/external/Документ/{ИмяОбъекта}/{id}/post`

Выполняет операцию проведения документа. Запускает все серверные проверки (`ПередПроведением`) и создает движения в регистрах.
- **Тело запроса:** Пустое.
- **Успешный ответ:** `200 OK` с сообщением `{"message": "Document posted successfully."}`.
- **Ответ при ошибке:** `400 Bad Request` с описанием ошибки, если проверки не пройдены (например, не хватает остатков).

### 4.2. Отмена проведения документа
`POST /api/v1/external/Документ/{ИмяОбъекта}/{id}/unpost`

Отменяет проведение документа и удаляет связанные с ним движения.
- **Тело запроса:** Пустое.
- **Успешный ответ:** `200 OK` с сообщением `{"message": "Document un-posted successfully."}`.

---

## 5. Коды ответов и Обработка ошибок

| Код | Описание |
| :--- | :--- |
| `200 OK` | Успешный запрос. |
| `201 Created` | Ресурс успешно создан. |
| `204 No Content`| Ресурс успешно удален, тело ответа пустое. |
| `400 Bad Request` | Ошибка валидации. Тело ответа содержит массив ошибок. |
| `401 Unauthorized`| Аутентификация не пройдена (неверный токен/ключ). |
| `403 Forbidden` | Аутентификация пройдена, но у пользователя нет прав на данную операцию. |
| `404 Not Found` | Запрошенный ресурс не найден. |
| `429 Too Many Requests`| Превышен лимит запросов. |
| `500 Internal Server Error` | Внутренняя ошибка сервера. |

**Пример ответа с ошибкой валидации (400 Bad Request):**
```json
{
  "errors": [
    {
      "field": "ИНН",
      "message": "Поле ИНН должно быть заполнено."
    },
    {
      "field": "Товары[0].Количество",
      "message": "Количество не может быть отрицательным."
    }
  ]
}
```

---

## 6. Ограничения (Rate Limiting)

Для обеспечения стабильности, API ограничивает количество запросов. По умолчанию — **1000 запросов в минуту** с одного IP-адреса.

При каждом запросе сервер возвращает следующие заголовки:
-   `X-RateLimit-Limit`: Общий лимит запросов в текущем окне.
-   `X-RateLimit-Remaining`: Количество оставшихся запросов.
-   `X-RateLimit-Reset`: Время в UTC-секундах, когда лимит будет сброшен.

Если лимит превышен, API вернет ошибку `429 Too Many Requests`.

